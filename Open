import express from "express";
import bodyParser from "body-parser";
import cors from "cors";
import fetch from "node-fetch";
import path from "path";
import { fileURLToPath } from "url";
import { Low } from "lowdb";
import { JSONFile } from "lowdb/node";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const dbFile = path.join(__dirname, "data.json");
const adapter = new JSONFile(dbFile);
const db = new Low(adapter, { records: [] });

const app = express();
app.use(cors());
app.use(bodyParser.json());
app.use(express.static(path.join(__dirname, "public")));

await db.read();

// ðŸ”¹ Replace this with your own Google Script Web App URL
const GOOGLE_SHEET_WEBHOOK = "https://script.google.com/macros/s/AKfycbyiZyzDWZp6aSh5jeHGhqMbzvXelFiykEUjrC4GWHa4exfuImVCpe3KHDXa0Y8Amk4/exec";

// ðŸ”¹ Price calculator
function calculatePrice(service, distanceKm = 5) {
  const BASE = 3;
  const PER_KM = 1.2;
  const MULT = { delivery: 1, cleaning: 1.5, errand: 1.3 };
  const m = MULT[service.toLowerCase()] || 1;
  return Math.max(5, Math.round((BASE + PER_KM * distanceKm) * m * 100) / 100);
}

// ðŸ”¹ API to receive form data
app.post("/submit", async (req, res) => {
  const record = req.body;
  record.date = new Date().toISOString();
  record.price = calculatePrice(record.service || "delivery", 5);

  db.data.records.push(record);
  await db.write();

  // ðŸ”¹ Send to Google Sheets
  try {
    await fetch(GOOGLE_SHEET_WEBHOOK, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(record)
    });
    console.log("âœ… Synced with Google Sheet:", record);
  } catch (err) {
    console.error("âŒ Google sync failed:", err);
  }

  res.json({ ok: true, message: "Saved & synced", record });
});

// ðŸ”¹ Health check
app.get("/api/health", (req, res) => {
  res.json({ ok: true, app: "Zongo Express Birmingham" });
});

const PORT = process.env.PORT || 8080;
app.listen(PORT, () =>
  console.log(`ðŸšš Zongo Express running at http://localhost:${PORT}`)
);
